version: '3.8'

services:
  # Local PostgreSQL Database (for development)
  postgres:
    image: pgvector/pgvector:pg15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=Newsjuice25+
      - POSTGRES_DB=newsdb
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    restart: unless-stopped
    networks:
      - chatter-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Your Chatter API
  api:
    build: 
      context: .
      #args:
        #HUGGING_FACE_HUB_TOKEN: ${HUGGING_FACE_HUB_TOKEN}
    env_file:
      - .env.local  # Use .env.local for local development
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database
      - DATABASE_URL=postgresql://postgres:Newsjuice25%2B@postgres:5432/newsdb
      - DB_URL=postgresql://postgres:Newsjuice25%2B@postgres:5432/newsdb
      
      # OpenAI
      # - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Google Cloud
      - GOOGLE_CLOUD_PROJECT=famous-phalanx-471817-q2
      - GOOGLE_CLOUD_REGION=us-central1
      - GOOGLE_APPLICATION_CREDENTIALS=/app/sa-key.json
      - FIREBASE_SERVICE_ACCOUNT_PATH=/app/firebase-admin-key.json
      - GEMINI_SERVICE_ACCOUNT_PATH=/secrets/gemini-service-account.json
      
      # Google AI API (for Live API - loaded from .env.local via env_file)
      
      # GCS
      - AUDIO_BUCKET=newsjuice-local-audio
      - GCS_PREFIX=podcasts/
      - CACHE_CONTROL=public, max-age=3600
      
      # CORS
      # - CORS_ALLOW_ORIGINS=http://localhost:3000,http://localhost:8080,http://localhost:8000
      - CORS_ALLOW_ORIGINS=http://localhost:3000,http://localhost:8080,http://localhost:8000,http://localhost:5173
      
      # Server
      - PORT=8080
      
      # Model path (baked into image)
      #- SENTENCE_MODEL_PATH=/app/models/all-mpnet-base-v2
    
    volumes:
      # Mount service account keys (read-only)
      - ../../../secrets/firebase-admin-key.json:/app/firebase-admin-key.json:ro
      - ../../../secrets/sa-key.json:/app/sa-key.json:ro
      - ../../../secrets/gemini-service-account.json:/secrets/gemini-service-account.json:ro
      
      # Optional: Mount code for hot-reload during development
      # Uncomment these lines if you want to edit code without rebuilding
      - ./main.py:/app/main.py
      # - ./chatter_handler.py:/app/chatter_handler.py
      - ./helpers.py:/app/helpers.py
      - ./retriever.py:/app/retriever.py
      - ./text_to_speech_client.py:/app/text_to_speech_client.py
      - ./user_db.py:/app/user_db.py
      - ./firebase_auth.py:/app/firebase_auth.py
      - ./query_enhancement.py:/app/query_enhancement.py
      - ./speech_to_text_client.py:/app/speech_to_text_client.py
      - ./gcs_storage.py:/app/gcs_storage.py
    
    restart: unless-stopped
    networks:
      - chatter-network

networks:
  chatter-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
